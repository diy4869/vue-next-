import { o as n, c as s, a } from './app.c3e51dbf.js'
const t =
    '{"title":"transform 转换","description":"","frontmatter":{},"headers":[{"level":2,"title":"transform 转换","slug":"transform-转换"},{"level":2,"title":"获取基本转换预设","slug":"获取基本转换预设"},{"level":2,"title":"transform","slug":"transform"},{"level":2,"title":"总结","slug":"总结"}],"relativePath":"compiler/transform.md","lastUpdated":1625743456959}',
  p = {},
  o = a(
    '<h2 id="transform-转换"><a class="header-anchor" href="#transform-转换" aria-hidden="true">#</a> transform 转换</h2><p>前面的部分，对整个<code>parse</code>过程做了说明，这一系列，将对<code>transform</code>阶段做说明，依然会涉及多个部分，看到这里就完成了整个编译过程三分之一的内容了，这部分也算整个编译过程的一个重点，毕竟<code>Vue</code>提供了比较多的语法糖，都会在这一步做处理。</p><p>由于<code>transform</code>阶段整体过于复杂，将不会像<code>parse</code>阶段一样说的比较详细，之后将对这3个部分做一个简单的说明。有兴趣的话可以自己去研究下，代码在<code>packages/compiler-core/src/transform.ts</code>。本人能力有限，就不做说明了。</p><div class="language-ts"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>\n  template<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> RootNode<span class="token punctuation">,</span>\n  options<span class="token operator">:</span> CompilerOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token operator">:</span> CodegenResult <span class="token punctuation">{</span>\n\n  <span class="token comment">// 获取ast</span>\n  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">baseParse</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">:</span> template\n\n  <span class="token comment">// 转换</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>nodeTransforms<span class="token punctuation">,</span> directiveTransforms<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getBaseTransformPreset</span><span class="token punctuation">(</span>\n    prefixIdentifiers\n  <span class="token punctuation">)</span>\n\n  <span class="token function">transform</span><span class="token punctuation">(</span>\n    ast<span class="token punctuation">,</span>\n    <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      prefixIdentifiers<span class="token punctuation">,</span>\n      nodeTransforms<span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token operator">...</span>nodeTransforms<span class="token punctuation">,</span>\n        <span class="token operator">...</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>nodeTransforms <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// user transforms</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      directiveTransforms<span class="token operator">:</span> <span class="token function">extend</span><span class="token punctuation">(</span>\n        <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n        directiveTransforms<span class="token punctuation">,</span>\n        options<span class="token punctuation">.</span>directiveTransforms <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// user transforms</span>\n      <span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span>\n\n  <span class="token comment">// 生成block tree 用于最终渲染</span>\n  <span class="token keyword">return</span> <span class="token function">generate</span><span class="token punctuation">(</span>\n    ast<span class="token punctuation">,</span>\n    <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      prefixIdentifiers\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>从上面可以知道先去执行了<code>getBaseTransformPreset</code>，并且做了解构赋值，之后调用了<code>transform</code>方法，把上一步拿到的AST和一些配置去做了合并去执行了<code>transform</code>。下面就先看下<code>getBaseTransformPreset</code>干了啥。</p><h2 id="获取基本转换预设"><a class="header-anchor" href="#获取基本转换预设" aria-hidden="true">#</a> 获取基本转换预设</h2><div class="language-ts"><pre><code><span class="token comment">// 获取基本转换预设</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getBaseTransformPreset</span><span class="token punctuation">(</span>\n  prefixIdentifiers<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>\n<span class="token punctuation">)</span><span class="token operator">:</span> TransformPreset <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      transformOnce<span class="token punctuation">,</span>\n      transformIf<span class="token punctuation">,</span>\n      transformFor<span class="token punctuation">,</span>\n      <span class="token operator">...</span><span class="token punctuation">(</span>__COMPAT__ <span class="token operator">?</span> <span class="token punctuation">[</span>transformFilter<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span><span class="token punctuation">(</span><span class="token operator">!</span>__BROWSER__ <span class="token operator">&amp;&amp;</span> prefixIdentifiers\n        <span class="token operator">?</span> <span class="token punctuation">[</span>\n            <span class="token comment">// order is important</span>\n            trackVForSlotScopes<span class="token punctuation">,</span>\n            transformExpression\n          <span class="token punctuation">]</span>\n        <span class="token operator">:</span> __BROWSER__ <span class="token operator">&amp;&amp;</span> __DEV__\n          <span class="token operator">?</span> <span class="token punctuation">[</span>transformExpression<span class="token punctuation">]</span>\n          <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      transformSlotOutlet<span class="token punctuation">,</span>\n      transformElement<span class="token punctuation">,</span>\n      trackSlotScopes<span class="token punctuation">,</span>\n      transformText\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      on<span class="token operator">:</span> transformOn<span class="token punctuation">,</span>\n      bind<span class="token operator">:</span> transformBind<span class="token punctuation">,</span>\n      model<span class="token operator">:</span> transformModel\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>从上面可以看到<code>getBaseTransformPreset</code>提供了<code>once、if、for、slot、slotScope、on、bind、model</code>的一个转换。现在再来看下<code>transform</code>的实现。</p><h2 id="transform"><a class="header-anchor" href="#transform" aria-hidden="true">#</a> transform</h2><div class="language-ts"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">transform</span><span class="token punctuation">(</span>root<span class="token operator">:</span> RootNode<span class="token punctuation">,</span> options<span class="token operator">:</span> TransformOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 创建转换器上下文</span>\n  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createTransformContext</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> options<span class="token punctuation">)</span>\n  <span class="token comment">// 针对生成好的AST去做转换</span>\n  <span class="token function">traverseNode</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> context<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>hoistStatic<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 静态提升</span>\n    <span class="token function">hoistStatic</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> context<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>ssr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 创建跟节点代码生成</span>\n    <span class="token function">createRootCodegen</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> context<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// finalize meta information</span>\n  root<span class="token punctuation">.</span>helpers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>context<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n  root<span class="token punctuation">.</span>components <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>context<span class="token punctuation">.</span>components<span class="token punctuation">]</span>\n  root<span class="token punctuation">.</span>directives <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>context<span class="token punctuation">.</span>directives<span class="token punctuation">]</span>\n  root<span class="token punctuation">.</span>imports <span class="token operator">=</span> context<span class="token punctuation">.</span>imports\n  root<span class="token punctuation">.</span>hoists <span class="token operator">=</span> context<span class="token punctuation">.</span>hoists\n  root<span class="token punctuation">.</span>temps <span class="token operator">=</span> context<span class="token punctuation">.</span>temps\n  root<span class="token punctuation">.</span>cached <span class="token operator">=</span> context<span class="token punctuation">.</span>cached\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>__COMPAT__<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    root<span class="token punctuation">.</span>filters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>context<span class="token punctuation">.</span>filters<span class="token operator">!</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h2 id="总结"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p><code>transform</code>内部主要干了几件事：</p><ul><li>创建转换器上下文</li><li>对节点进行转换</li><li>静态提升</li><li>创建根节点代码生成</li></ul><p>下面将对这些内容，做简单说明。</p>',
    14
  )
p.render = function(a, t, p, e, c, u) {
  return n(), s('div', null, [o])
}
export default p
export { t as __pageData }
